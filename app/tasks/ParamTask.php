<?php

use Phalcon\Cli\Task;

class ParamTask extends Task
{




    private $footerScripts = [
        'lt' =>
            <<<'EOT'
        <div id="om-gmssbdmvmkpglj50-holder"></div><script>var gmssbdmvmkpglj50,gmssbdmvmkpglj50_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){gmssbdmvmkpglj50_poll(function(){if(window['om_loaded']){if(!gmssbdmvmkpglj50){gmssbdmvmkpglj50=new OptinMonsterApp();return gmssbdmvmkpglj50.init({u:"11462.303554",staging:0,dev:0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;gmssbdmvmkpglj50=new OptinMonsterApp();gmssbdmvmkpglj50.init({u:"11462.303554",staging:0,dev:0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script>
    <div id="om-fyi02zidebhgsg8v-holder"></div><script>var fyi02zidebhgsg8v,fyi02zidebhgsg8v_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){fyi02zidebhgsg8v_poll(function(){if(window['om_loaded']){if(!fyi02zidebhgsg8v){fyi02zidebhgsg8v=new OptinMonsterApp();return fyi02zidebhgsg8v.init({u:"11462.218873",staging:0,dev:0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optinmonster.com/app/js/api.min.js",o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;fyi02zidebhgsg8v=new OptinMonsterApp();fyi02zidebhgsg8v.init({u:"11462.218873",staging:0,dev:0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script>
    <div id="om-gmssbdmvmkpglj50-holder"></div><script>var gmssbdmvmkpglj50,gmssbdmvmkpglj50_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){gmssbdmvmkpglj50_poll(function(){if(window['om_loaded']){if(!gmssbdmvmkpglj50){gmssbdmvmkpglj50=new OptinMonsterApp();return gmssbdmvmkpglj50.init({u:"11462.303554",staging:0,dev:0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;gmssbdmvmkpglj50=new OptinMonsterApp();gmssbdmvmkpglj50.init({u:"11462.303554",staging:0,dev:0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script>
    <!-- This site is converting visitors into subscribers and customers with OptinMonster - http://optinmonster.com :: Campaign Title: Šventinės pristatymo kainos --><div id="om-ls3pvgrofjrl9i0x-holder"></div><script>var ls3pvgrofjrl9i0x,ls3pvgrofjrl9i0x_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){ls3pvgrofjrl9i0x_poll(function(){if(window['om_loaded']){if(!ls3pvgrofjrl9i0x){ls3pvgrofjrl9i0x=new OptinMonsterApp();return ls3pvgrofjrl9i0x.init({"u":"11462.479048","staging":0,"dev":0,"beta":0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.async=true,o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;ls3pvgrofjrl9i0x=new OptinMonsterApp();ls3pvgrofjrl9i0x.init({"u":"11462.479048","staging":0,"dev":0,"beta":0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script><!-- / OptinMonster -->

        <script type="text/javascript">
        window.$zopim||(function(d,s){var z=$zopim=function(c){z._.push(c)},$=z.s=
                d.createElement(s),e=d.getElementsByTagName(s)[0];z.set=function(o){z.set.
        _.push(o)};z._=[];z.set._=[];$.async=!0;$.setAttribute('charset','utf-8');
            $.src='//v2.zopim.com/?42SVyht9EGv3mgnGxf8w5k36uYvzjvuZ';z.t=+new Date;$.
                    type='text/javascript';e.parentNode.insertBefore($,e)})(document,'script');
    </script>
EOT
        ,
        'lv' =>
            <<<'EOT'
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-M8KG3X" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M8KG3X');</script>
<!-- End Google Tag Manager -->

<!-- This site is converting visitors into subscribers and customers with OptinMonster - http://optinmonster.com --><script>var om5608e71652d84,om5608e71652d84_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){om5608e71652d84_poll(function(){if(window['om_loaded']){if(!om5608e71652d84){om5608e71652d84=new OptinMonsterApp();return om5608e71652d84.init({"s":"11462.5608e71652d84","staging":0,"dev":0,"beta":0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.async=true,o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;om5608e71652d84=new OptinMonsterApp();om5608e71652d84.init({"s":"11462.5608e71652d84","staging":0,"dev":0,"beta":0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script><!-- / OptinMonster -->
<div id="om-uthsh0y0gpo4qpoz-holder"></div><script>var uthsh0y0gpo4qpoz,uthsh0y0gpo4qpoz_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){uthsh0y0gpo4qpoz_poll(function(){if(window['om_loaded']){if(!uthsh0y0gpo4qpoz){uthsh0y0gpo4qpoz=new OptinMonsterApp();return uthsh0y0gpo4qpoz.init({u:"11462.236385",staging:0,dev:0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;uthsh0y0gpo4qpoz=new OptinMonsterApp();uthsh0y0gpo4qpoz.init({u:"11462.236385",staging:0,dev:0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script>
EOT

    ];

    private $paramCollection = [
        'site_logo_url' => [
            'lt' => 'bundles/foodapp/images/logo_food.png',
            'lv' => 'bundles/foodapp/images/logo_food2.png',
            'ee' => 'bundles/foodapp/images/logo_food_ee.png'
        ],
        'optin_code' => [
            'lt' => '<div id="om-nkcu3qstsjxkdv12-holder"></div><script>var nkcu3qstsjxkdv12,nkcu3qstsjxkdv12_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){nkcu3qstsjxkdv12_poll(function(){if(window[\'om_loaded\']){if(!nkcu3qstsjxkdv12){nkcu3qstsjxkdv12=new OptinMonsterApp();return nkcu3qstsjxkdv12.init({"u":"11462.367922","staging":0,"dev":0,"beta":0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;nkcu3qstsjxkdv12=new OptinMonsterApp();nkcu3qstsjxkdv12.init({"u":"11462.367922","staging":0,"dev":0,"beta":0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script>',
            'lv' => '<div id="om-xx1z1otqbssjrm1t-holder"></div><script>var xx1z1otqbssjrm1t,xx1z1otqbssjrm1t_poll=function(){var r=0;return function(n,l){clearInterval(r),r=setInterval(n,l)}}();!function(e,t,n){if(e.getElementById(n)){xx1z1otqbssjrm1t_poll(function(){if(window[\'om_loaded\']){if(!xx1z1otqbssjrm1t){xx1z1otqbssjrm1t=new OptinMonsterApp();return xx1z1otqbssjrm1t.init({"u":"11462.367923","staging":0,"dev":0,"beta":0});}}},25);return;}var d=false,o=e.createElement(t);o.id=n,o.src="//a.optnmnstr.com/app/js/api.min.js",o.onload=o.onreadystatechange=function(){if(!d){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){try{d=om_loaded=true;xx1z1otqbssjrm1t=new OptinMonsterApp();xx1z1otqbssjrm1t.init({"u":"11462.367923","staging":0,"dev":0,"beta":0});o.onload=o.onreadystatechange=null;}catch(t){}}}};(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}(document,"script","omapi-script");</script>',
        ],
        'game_revive_zone_id' => [
            'lt' => 8,
            'lv' => 16,
            'ee' => 16
        ]

    ];

    /**
     * Naujas uzsakymas. Dar neperduotas restoranui
     * @var string
     */
    public static $status_new = "new";
    /**
     * @var string Nepavyko apmokejimas
     */
    public static $status_failed = "failed";
    public static $status_accepted = "accepted";
    public static $status_assiged = "assigned";
    public static $status_delayed = "delayed";
    public static $status_forwarded = "forwarded";
    public static $status_completed = "completed";
    public static $status_finished = "finished";
    public static $status_canceled = "canceled";
    public static $status_canceled_produced = "canceled_produced";

    /**
     * Nemaisyti su pre.. cia orderis laikui
     * @var string
     */
    public static $status_preorder = "preorder";
    public static $status_pre = "pre";
    public static $status_unapproved = "unapproved";
    public static $status_nav_problems = "nav_problems";
    public static $status_partialy_completed = "partialy_completed";

    public static $type_pickup = 'pickup';
    public static $type_simple = 'order';

    const SOURCE_NAV = "nav";
    const SOURCE_APIV1 = "apiv1";
    const SOURCE_APIV2 = "apiv2";
    const SOURCE_FOODOUT = "foodout";

    private $messages = [
        'lv' => [
            'sms' =>
                [
                    'order_created' => 'Sveiki. Foodout.lv sanema Tavu pasutijumu Nr. order_id. Rupesimies par ta piegadi delivery_time laika! :)',
                    'order_created_pickup' => 'Sveiki. restaurant_name sanema Tavu pasutijumu. Panemt to varesi pre_delivery_time! :)',
                    'order_created_preorder' => 'Sveiki. Pasutijums Nr. order_id ir pienemts. Tas tiks piegadats pre_delivery_time! Tavs Foodout.lv :)',
                    'order_created_preorder_pickup' => 'Sveiki. restaurant_name sanema Tavu pasutijumu. Panemt to varesi pre_delivery_time! :)',
                    'order_accepted_preorder' => 'Sveiki. restaurant_name sanema Tavu pasutijumu. Tas tiks piegadats pre_delivery_time! Tavs Foodout.lv :)',
                    'order_accepted_preorder_pickup' => 'Sveiki. Savu pasutijumu varesi sanemt pre_delivery_time! Tavs Foodout.lv',
                    'order_delayed' => 'Atvaino, sakara ar lielo restorana noslodzi, pasutijums kavesies delay_time. Pasutijuma Nr. order_id. :(',
                    'order_delayed_pickup' => 'Atvaino, sakara ar lielo restorana noslodzi, pasutijums kavesies delay_time. Pasutijuma Nr. order_id. :(',
                    'order_completed' => 'Paldies par pasutijumu. Ielade Foodout mobilo aplikaciju un sanem labakos piedavajumus: http://bit.ly/2nM2ORF',
                ]
        ]
    ];

    private $replace = [
        'search'    => ['order_id', 'restaurant_name', 'delivery_time', 'pre_delivery_time'],
        'replace'   => ['[order_id]', '[restaurant_name]', '[delivery_time]', '[pre_delivery_time]']
    ];

    public function smsAction()
    {
        try {
            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_created']);
            $obj->status = self::$status_new;
            $obj->preorder = false;
            $obj->type = self::$type_simple;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_created_pickup']);
            $obj->status = self::$status_new;
            $obj->preorder = false;
            $obj->type = self::$type_pickup;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_created_preorder']);
            $obj->status = self::$status_new;
            $obj->preorder = true;
            $obj->type = self::$type_simple;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_created_preorder_pickup']);
            $obj->status = self::$status_new;
            $obj->preorder = true;
            $obj->type = self::$type_pickup;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_accepted_preorder']);
            $obj->status = self::$status_accepted;
            $obj->preorder = false;
            $obj->type = self::$type_simple;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_accepted_preorder_pickup']);
            $obj->status = self::$status_accepted;
            $obj->preorder = true;
            $obj->type = self::$type_pickup;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_delayed']);
            $obj->status = self::$status_delayed;
            $obj->preorder = false;
            $obj->type = self::$type_simple;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_delayed_pickup']);
            $obj->status = self::$status_accepted;
            $obj->preorder = false;
            $obj->type = self::$type_pickup;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();

            $obj = new SmsTemplate();
            $obj->text = str_replace($this->replace['search'], $this->replace['replace'], $this->messages[$this->config->params->locale]['sms']['order_completed']);
            $obj->status = self::$status_completed;
            $obj->preorder = false;
            $obj->type = self::$type_simple;
            $obj->source = self::SOURCE_FOODOUT;
            $obj->active = true;
            $obj->create();


        } catch (\Exception $e) {
            $this->db->rollback();
            echo $e->getMessage() . PHP_EOL;
        }
    }

    public function mainAction()
    {


        try {
            $this->db->begin();
            $country = $this->config->params->country;

            if ($this->footerScripts[$country]) {
                $item = Params::findFirstByParam('footer_scripts');

                if (!is_object($item)) {
                    $item = new Params();
                    $item->param = 'footer_scripts';
                }

                $item->value = $this->footerScripts[$country];

                $item->save();
            }
//
//            $query = "INSERT INTO `common_slug_forward` (`id`, `slug`, `locale`, `controller`, `params`) VALUES
//(1, '1822/cili-pica', 'lt', 'FoodDishesBundle:Place:index', \"{'id'':'63','slug':'cili-pica','categoryId':'','oldFriendIsHere':'1'}\"),
//(2, '1822/cili-kaimas', 'lt', 'FoodDishesBundle:Place:index', \"'{'id':'67','slug':'cili-kaimas-kaunas','categoryId':'','oldFriendIsHere':'1'}\"),
//(3, '1822/soya', 'lt', 'FoodDishesBundle:Place:index', \"{'id':'70','slug':'soya','categoryId':'','oldFriendIsHere':'1'}\")";

//            if ($di->get('config')->params->country == 'lt') {
//                $this->db->query($query)->execute();
//            }
            foreach ($this->paramCollection as $paramName => $values) {
                if (isset($values[$country])) {
                    $item = Params::findFirstByParam($paramName);
                    if (!is_object($item)) {
                        $item = new Params();
                        $item->param = $paramName;
                    }
                    $item->value = $values[$country];
                    $item->save();
                }
            }
            $this->db->commit();
        } catch (Exception $e) {
            echo $e->getMessage() . PHP_EOL;
            exit;
        } finally {
            echo 'Params imported succesfully' . PHP_EOL;
        }
    }

    public function pageParamsAction()
    {

        $pageCollection = StaticContent::find();
        try {
            $this->db->begin();
            foreach ($pageCollection as $page) {
                if (strpos($page->content, "{{ faq_video }}") !== false) {
                    $video = '<iframe width="560" height="315" src="' . $this->config->params->yt_embeded . '" frameborder="0" allowfullscreen></iframe>';
                    $cont = $page->content;
                    $page->content = str_replace("{{ faq_video }}", $video, $cont);
                    $page->update();
                }
            }
            $this->db->commit();
        } catch (\Exception $e) {
            echo $e->getMessage() . PHP_EOL;
            exit;
        }

        echo 'Pages updated.' . PHP_EOL;
    }

    public function mailAction()
    {//Soriuką
        try {
            $this->db->begin();

            $id = $this->config->params->mailer_notify_on_accept;

            $mailTmpl = new EmailTemplate();
            $mailTmpl->templateId = $id;
            $mailTmpl->status = self::$status_accepted;
            $mailTmpl->active = true;
            $mailTmpl->preorder = false;
            $mailTmpl->type = self::$type_simple;
            $mailTmpl->source = true;
            $mailTmpl->create();

            $id = $this->config->params->mailer_notify_pickup_on_accept;
            $mailTmpl = new EmailTemplate();
            $mailTmpl->templateId = $id;
            $mailTmpl->status = self::$status_accepted;
            $mailTmpl->active = true;
            $mailTmpl->preorder = false;
            $mailTmpl->type = self::$type_pickup;
            $mailTmpl->source = true;
            $mailTmpl->create();
//        $id = $this->config->params->mailer_notify_new_user;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;
//
//        $id = $this->config->params->mailer_user_reset;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;

            $id = $this->config->params->mailer_partialy_deliverer;
            $mailTmpl = new EmailTemplate();
            $mailTmpl->templateId = $id;
            $mailTmpl->status = self::$status_partialy_completed;
            $mailTmpl->active = true;
            $mailTmpl->preorder = false;
            $mailTmpl->type = self::$type_simple;
            $mailTmpl->source = true;
            $mailTmpl->create();
//        $id = $this->config->params->mailer_rate_your_food;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;

//        $id = $this->config->params->mailer_send_invoice;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;

//        $id = $this->config->params->mailer_send_corporate_invoice;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;
//
//        $id = $this->config->params->mailer_send_corporate_changed_password;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;
//
//        $id = $this->config->params->mailer_send_free_delivery_discount;
//        $mailTmpl = new EmailTemplate();
//        $mailTmpl->templateId = $id;
//        $mailTmpl->active = true;
//        $mailTmpl->preorder = true;
//        $mailTmpl->type = self::$status_accepted;
//        $mailTmpl->source = true;
            $this->db->commit();
            echo 'Mail templates created' . PHP_EOL;
        } catch (\Exception $e) {
            $this->db->rollback();
            echo $e->getMessage() . PHP_EOL;
        }
    }




}